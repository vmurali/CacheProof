Cache-coherent shared memory is the foundation for today's high-performance
multicore hardware platforms.  Previous work has verified correctness of
shared memory implementations for finite-state systems, for fixed topologies of
processors and caches.  We present the first formal verification of correctness
for an \emph{infinite} family of memory hierarchies, via machine-checked proofs
in the Coq proof assistant.  First, we identify a set of general invariants
and prove formally that they imply cache coherence.  Then we give a proof
for the concrete example of the directory-based MSI protocol, establishing
correct behavior for arbitrary tree-shaped memory hierarchies.
Our key insight for proving the invariants is a set of
fundamental properties shared with other protocols like MESI, MOSI,
and MOESI, enabling reuse of portions of our MSI proof for their verification.
