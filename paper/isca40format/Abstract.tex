
It is straightforward to define MSI and many other protocols where the protocol
engine has a global view of all caches in the system.  The design problem gets
much harder when one wants to refine these protocols to multi-level hierarchical
cache systems where the protocol engine is distributed; each cache controller
can examine only its local state, and state transitions are caused by
exchanging messages with other caches controllers. We present a procedure to
automatically generate a distributed implementation from a global MSI protocol
description for hierarchical caches. Our procedure is based on preserving two
important invariants: a) the directory's notion of the permissions for the
caches it serves is ``conservative'', \ie the caches do not have more
permission than what is assumed by the directory; and b) every request by a
cache or a directory will eventually get a response. It has been shown
elsewhere, using the Coq theorem prover, that our distributed protocol
preserves these invariants.  The protocol we generate can be implemented using
$2N + 2$ virtual channels where $N + 1$ is the number of levels. We finally show
that our protocol has no extra overhead (in terms of state bits or the number
of messages passed to service each request) compared to the published
implementations of this protocol. 
