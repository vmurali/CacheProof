This work is the first verification of a directory-based cache coherence
protocol parameterized for any hierarchy (Reviewer 3, please note that any
cache hierarchy is indeed a tree-hierarchy). Directory based protocols have
intermediate states to keep track of waiting states, and these intermediate
states are designed and reasoned about in an ad-hoc manner - and these ad-hoc
reasoning/design is difficult and usually does not scale with more levels in
the hierarchy. We provide a systematic way to reason about (and design) the
intermediate wait states for a general hierarchy, clearly specifying the
semantics of the intermediate states. This by itself is a novel contribution.
Of course, current processors have only 2 to 4 levels of hierarchy (note to
Reviewer 4: Intel Itanium and Haswell has 4 levels of caches), but with the
current trend, it is not unfathomable to imagine the number of cores increasing
to thousands and even millions, at which point multi-level hierarchies will
become very important.

Next, we provide a declarative definition of store atomicity. We believe this
is the first work that spells out all the conditions sufficient to make a cache system
behave like atomic memory without caches (Lamport's model "How to Make a
Multiprocessor Computer That Correctly Executes Multiprocess Programs"). All
previous verification work stop at proving that two cache states are never both
in "M", which is an important invariant but not sufficient.

The insight for the proof presented in the paper has not been presented before,
namely, viewing multiple cache coherence protocols in a unified manner sharing
a common proof substrate, all of which depends on seemingly unremarkable
properties of "no-crossing of messages" and "FIFO delivery". In fact, most of
the human effort in this project was in coming up with the insight for viewing
multiple protocols in a unified manner. Protocols other than MSI have not been
formally proven, but the libraries we provide in the proof of MSI can be used
without any modification for the other protocols (this constitutes more than
80% of the 12000-line Coq proof that we had written). Moreover, the invariants
that remain to be proven for MOSI/MOESI protocols is restricted to a system
containing exactly 3 nodes, and a single address, making it amenable to
model-checking.

We acknowledge Reviewer 4 for pointing out the other works on verifying cache
coherence (especially using model checking techniques while still being
parametric on the number of processors). These works a) support only one-level
hierarchy and b) all except one prove correctness of snoopy protocols. Other
works that we have looked are similar or they verify a specific instance.

This protocol has been implemented in a multicore PowerPC system (Fast and
cycle-accurate modeling of a multicore processor, ISPASS-2012) with 2 levels of
hierarchy, and the performance obtained is similar to other systems. One
obstacle in the implementation is that one atomic transition of Figure 3 can
span several clock cycles, requiring bookkeeping to keep it atomic.

Extending the proof to broadcast-based protocols: The first-level invariants
remain as is, but beyond that, the reasoning becomes different.

